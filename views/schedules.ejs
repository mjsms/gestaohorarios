<!-- Button to open the modal for uploading schedules -->
<a class="waves-effect waves-light btn modal-trigger" href="#uploadModal">Upload de Horários</a>

<!-- Modal structure -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h4>Upload de Horários</h4>
        <form id="uploadHorariosForm" enctype="multipart/form-data">
            <div class="file-field input-field">
                <div class="btn">
                    <span>Selecionar Ficheiro</span>
                    <input type="file" id="horariosFile" name="file">
                </div>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" placeholder="Selecione o ficheiro de horários (CSV)">
                </div>
            </div>
            <button type="submit" class="btn waves-effect waves-light">Upload Horários</button>
        </form>
        <!-- Spinner -->
        <div id="spinner" style="display: none; text-align: center; margin-top: 20px;">
            <div class="preloader-wrapper active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                </div>
            </div>
            <p>Processando o upload...</p>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Fechar</a>
    </div>
</div>

<div class="row">
    <!-- Container for the Tabulator table -->
    <h3>Horários</h3>
    <div class="table-container col s12">
        <div id="versions-table"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        M.Modal.init(elems);

        // Fetch schedule versions and display in Tabulator
        const table = new Tabulator("#versions-table", {
            ajaxURL: "/schedule/json", // Endpoint to fetch schedule versions
            ajaxConfig: "GET", // Request type
            pagination: "remote", // Enable remote pagination
            paginationSize: 10, // Rows per page
            autoColumns: false, // Custom columns
            layout: "fitColumns",
            columns: [
                { title: "Versão", field: "id", sorter: "number" },
                { title: "Data de Upload", field: "createdAt", sorter: "datetime", formatter: "datetime", formatterParams: { outputFormat: "DD/MM/YYYY HH:mm" } },
                { title: "Descrição", field: "description", sorter: "string" },
                { title: "Estado", field: "status", sorter: "string" },
                { 
                    title: "Ações", 
                    formatter: function(cell, formatterParams) {
                        const id = cell.getRow().getData().id;
                        return `<a href="/schedule-version/${id}" class="btn-small waves-effect waves-light">Ver</a>`;
                    }
                },
            ],
        });

        // Handle the upload form submission
        document.getElementById('uploadHorariosForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const spinner = document.getElementById('spinner');
            const form = document.getElementById('uploadHorariosForm');

            form.style.display = 'none'; // Hide the form
            spinner.style.display = 'block'; // Show the spinner

            fetch('schedule/upload', {
                method: 'POST',
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar o ficheiro.');
                    }
                    return response.text();
                })
                .then(() => {
                    spinner.style.display = 'none';
                    M.toast({ html: 'Versão de horários carregada com sucesso!', classes: 'green' });
                    location.reload();
                })
                .catch((error) => {
                    form.style.display = 'block';
                    spinner.style.display = 'none';
                    M.toast({ html: error.message || 'Erro ao carregar o ficheiro.', classes: 'red' });
                });
        });
    });
</script>

<style>
    .table-container {
        overflow-x: auto;
    }

    #spinner .preloader-wrapper {
        display: inline-block;
    }
</style>
